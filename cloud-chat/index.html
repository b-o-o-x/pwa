<style>
    /* ... 이전 스타일 유지 ... */
    
    /* 알림 바 스타일 */
    #notification-toast {
        position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 400px; background: rgba(0,0,0,0.85); color: white;
        padding: 12px 20px; border-radius: 50px; z-index: 9999;
        display: flex; align-items: center; gap: 10px; transition: 0.5s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); pointer-events: none;
    }
    #notification-toast.show { top: 20px; }

    /* 전송 영역 레이아웃 최적화 */
    .input-wrapper {
        display: flex; align-items: flex-end; gap: 8px; 
        max-width: 100%; width: 100%; box-sizing: border-box;
    }
    .input-box-container {
        flex: 1; min-width: 0; /* 중요: 내부 요소가 넘쳐도 부모를 늘리지 않음 */
        background: #f3f4f6; border-radius: 20px; display: flex; align-items: flex-end;
    }
</style>

<body class="theme-blue">
    <div id="notification-toast">
        <i class="fas fa-bell text-yellow-400"></i>
        <span id="noti-msg" class="text-sm truncate">새 메시지가 도착했습니다.</span>
    </div>
    <audio id="noti-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>

    <div class="p-2 sm:p-4 bg-white border-t mt-auto">
        <div class="input-wrapper mx-auto">
            <button id="emoji-btn" class="flex-none p-2 text-gray-400"><i class="far fa-smile text-2xl"></i></button>
            <div class="input-box-container">
                <textarea id="msg-input" rows="1" placeholder="입력..." class="w-full bg-transparent border-none py-3 px-3 text-[15px] outline-none resize-none max-h-32"></textarea>
            </div>
            <button id="send-btn" class="flex-none bg-main text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-90 transition">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script type="module">
        /* ... Firebase 초기화 부분 동일 ... */

        // 알림 기능 함수
        function playNotification(msg) {
            // 1. 소리 재생
            const sound = document.getElementById('noti-sound');
            sound.currentTime = 0;
            sound.play().catch(() => { /* 자동재생 방지 무시 */ });

            // 2. 알림 바 표시
            const toast = document.getElementById('notification-toast');
            const notiMsg = document.getElementById('noti-msg');
            notiMsg.innerText = `${msg.userName}: ${msg.text.substring(0, 20)}${msg.text.length > 20 ? '...' : ''}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        let isInitialLoad = true; // 처음 로딩 시 모든 메시지 알림 방지

        function loadMessages(roomId, joinedAt) {
            const q = query(
                collection(db, `rooms/${roomId}/messages`), 
                orderBy("createdAt", "asc"),
                where("createdAt", ">=", joinedAt)
            );

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const msgDiv = document.getElementById('messages');
                let lastMsg = null;

                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        renderMessage(msg, msgDiv);
                        lastMsg = msg;
                    }
                });

                // 3. 알림 조건: 초기 로딩이 아니고, 내가 보낸 메시지가 아닐 때
                if (!isInitialLoad && lastMsg && lastMsg.uid !== currentUser.uid) {
                    playNotification(lastMsg);
                }
                
                isInitialLoad = false;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }

        function renderMessage(msg, container) {
            const isMe = msg.uid === currentUser.uid;
            const timeStr = msg.createdAt ? formatTime(msg.createdAt.toDate()) : "";
            const emojiRegex = /^(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])$/;
            const isEmoji = emojiRegex.test(msg.text?.trim());

            if (msg.type === 'system') {
                container.innerHTML += `<div class="text-center text-[10px] text-gray-400 my-4 uppercase">${msg.text}</div>`;
            } else {
                container.innerHTML += `
                    <div class="flex ${isMe ? 'flex-row-reverse' : 'flex-row'} items-end gap-1 mb-3">
                        <img src="${msg.userPhoto}" class="w-7 h-7 rounded-full border mb-4 flex-none">
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[70%]">
                            <span class="text-[9px] text-gray-400 px-1">${msg.userName}</span>
                            <div class="${isEmoji ? 'big-emoji' : `px-3 py-2 rounded-2xl text-[14px] shadow-sm ${isMe ? 'bg-main text-white rounded-tr-none' : 'bg-white text-gray-800 border rounded-tl-none'}`}">
                                ${msg.text.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        <span class="text-[8px] text-gray-400 pb-1 flex-none">${timeStr}</span>
                    </div>`;
            }
        }

        // 방 입장 시 초기화 플래그 설정
        async function enterRoom(id, room) {
            isInitialLoad = true; // 방 이동 시 이전 메시지 알림 안 뜨게 초기화
            /* ... 기존 enterRoom 로직 ... */
        }

        /* ... 나머지 스크립트 동일 ... */
    </script>
</body>
